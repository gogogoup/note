<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Golang | doFun</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="be water my friend">
    <link rel="preload" href="/note/assets/css/0.styles.06ad8ea8.css" as="style"><link rel="preload" href="/note/assets/js/app.2e5e5d15.js" as="script"><link rel="preload" href="/note/assets/js/2.0d9fcc6c.js" as="script"><link rel="preload" href="/note/assets/js/17.a05d7a88.js" as="script"><link rel="prefetch" href="/note/assets/js/10.4020279d.js"><link rel="prefetch" href="/note/assets/js/11.98f21b9c.js"><link rel="prefetch" href="/note/assets/js/12.25bf1360.js"><link rel="prefetch" href="/note/assets/js/13.96901a78.js"><link rel="prefetch" href="/note/assets/js/14.fc5e00e8.js"><link rel="prefetch" href="/note/assets/js/15.7131b397.js"><link rel="prefetch" href="/note/assets/js/16.a6634466.js"><link rel="prefetch" href="/note/assets/js/18.984bce13.js"><link rel="prefetch" href="/note/assets/js/19.c5166816.js"><link rel="prefetch" href="/note/assets/js/20.d5aacbe4.js"><link rel="prefetch" href="/note/assets/js/21.93d62206.js"><link rel="prefetch" href="/note/assets/js/22.aa0aa2ea.js"><link rel="prefetch" href="/note/assets/js/23.31e27050.js"><link rel="prefetch" href="/note/assets/js/24.e846da92.js"><link rel="prefetch" href="/note/assets/js/25.480a41f4.js"><link rel="prefetch" href="/note/assets/js/26.96a87f01.js"><link rel="prefetch" href="/note/assets/js/27.ed072997.js"><link rel="prefetch" href="/note/assets/js/28.d0c806db.js"><link rel="prefetch" href="/note/assets/js/3.cdc5ffc6.js"><link rel="prefetch" href="/note/assets/js/4.fca74266.js"><link rel="prefetch" href="/note/assets/js/5.7ea98ef5.js"><link rel="prefetch" href="/note/assets/js/6.cecb269b.js"><link rel="prefetch" href="/note/assets/js/7.b8cf5606.js"><link rel="prefetch" href="/note/assets/js/8.eab8faa7.js"><link rel="prefetch" href="/note/assets/js/9.13153f45.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.06ad8ea8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">doFun</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/DailyShare/" class="nav-link">
  DailyShare
</a></div><div class="nav-item"><a href="/note/Writting/" class="nav-link">
  Writting
</a></div><div class="nav-item"><a href="https://github.com/gogogoup" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/DailyShare/" class="nav-link">
  DailyShare
</a></div><div class="nav-item"><a href="/note/Writting/" class="nav-link">
  Writting
</a></div><div class="nav-item"><a href="https://github.com/gogogoup" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/note/Javascript.html" class="sidebar-link">Javascript</a></li><li><a href="/note/Css.html" class="sidebar-link">Css</a></li><li><a href="/note/Go.html" class="active sidebar-link">Golang</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/Go.html#数组和切片关系" class="sidebar-link">数组和切片关系</a></li><li class="sidebar-sub-header"><a href="/note/Go.html#切片作为形参" class="sidebar-link">切片作为形参</a></li><li class="sidebar-sub-header"><a href="/note/Go.html#切片扩容方式" class="sidebar-link">切片扩容方式</a></li><li class="sidebar-sub-header"><a href="/note/Go.html#interface" class="sidebar-link">interface</a></li></ul></li><li><a href="/note/C.html" class="sidebar-link">C</a></li><li><a href="/note/Git.html" class="sidebar-link">Git</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="golang"><a href="#golang" class="header-anchor">#</a> Golang</h1> <p></p><div class="table-of-contents"><ul><li><a href="#数组和切片关系">数组和切片关系</a></li><li><a href="#切片作为形参">切片作为形参</a></li><li><a href="#切片扩容方式">切片扩容方式</a></li><li><a href="#interface">interface</a><ul><li><a href="#底层结构">底层结构</a></li></ul></li></ul></div><p></p> <h2 id="数组和切片关系"><a href="#数组和切片关系" class="header-anchor">#</a> 数组和切片关系</h2> <ul><li>数组<br>
是一段连续的内存，定长，且长度不能更改，导致<code>[3]int, [4]int</code>是不同类型，所以使用很少</li> <li>切片<br>
实际上是个结构体</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> slice <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token builtin">len</span> <span class="token builtin">int</span>
  <span class="token builtin">cap</span> <span class="token builtin">int</span>
  array unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>
</code></pre></div><p>所以切片是包含指向底层数组的指针。同时，底层数组也可以被其他切片引用，因此修改底层数组会影响到引用它的其他切片。</p> <h2 id="切片作为形参"><a href="#切片作为形参" class="header-anchor">#</a> 切片作为形参</h2> <p>函数传入切片作为形参到底是值传递还是引用传递？<br>
结论：是值传递</p> <h4 id="原因"><a href="#原因" class="header-anchor">#</a> 原因</h4> <ul><li>切片是个数组片段的描述，包含指向数组的指针，片段长度，容量，也就是说，它也可以看作是个结构体，成员是len，cap和数组指针。</li> <li>如果用原来切片新建一个切片的话，是不会复制底层数组的，只会改变指针的位置。</li> <li>当切片作为参数传入函数中时，应该是值传递，但是底层的数组是指向同一个数组的片段，所以直接通过索引改变底层数组的元素是会影响到实参，而获取底层数组元素的值后直接更改值，是不会影响到实参</li></ul> <h2 id="切片扩容方式"><a href="#切片扩容方式" class="header-anchor">#</a> 切片扩容方式</h2> <p>切片append新的元素之后大于原来底层数组的容量时，会进行扩容。此时切片会迁移到新的内存地址，底层数组长度增加，同时为了预防再次append，增加的容量会有一定规律：<br>
网上的：<code>当原 slice 容量小于 1024 的时候，新 slice 容量变成原来的 2 倍；原 slice 容量超过 1024，新 slice 容量变成原来的1.25倍。</code><br>
这个是不准确的，查看append的内部调用，容量不够时会调用growslice</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">growslice</span><span class="token punctuation">(</span>et <span class="token operator">*</span>_type<span class="token punctuation">,</span> old slice<span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token builtin">int</span><span class="token punctuation">)</span> slice <span class="token punctuation">{</span>
    <span class="token comment">// ……</span>
    newcap <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token builtin">cap</span>
	doublecap <span class="token operator">:=</span> newcap <span class="token operator">+</span> newcap
	<span class="token keyword">if</span> <span class="token builtin">cap</span> <span class="token operator">&gt;</span> doublecap <span class="token punctuation">{</span>
		newcap <span class="token operator">=</span> <span class="token builtin">cap</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> old<span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token punctuation">{</span>
			newcap <span class="token operator">=</span> doublecap
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> newcap <span class="token operator">&lt;</span> <span class="token builtin">cap</span> <span class="token punctuation">{</span>
				newcap <span class="token operator">+=</span> newcap <span class="token operator">/</span> <span class="token number">4</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ……</span>
	
	capmem <span class="token operator">=</span> <span class="token function">roundupsize</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>newcap<span class="token punctuation">)</span> <span class="token operator">*</span> ptrSize<span class="token punctuation">)</span>
	newcap <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>capmem <span class="token operator">/</span> ptrSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到:</p> <ul><li>当增加之后的新容量的两倍a大于就容量的两倍b时，会设定新容量为a</li> <li>当容量大于1024时，确实会增加到原来的1.25倍，但是在最后，会有roundupsize的调用，进行一次内存对齐，所以会导致新容量&gt;=旧容量的1.25倍</li></ul> <h2 id="interface"><a href="#interface" class="header-anchor">#</a> interface</h2> <p>接口是让go这个静态语言能够支持duck type，来完成动态语言形参不定义类型的写法，是编译器的一种对象推断策略。也是go解决没有范型的一种妥协？<br>
当函数的传入参数是个接口，只需要传入参数能实现接口定义的方法，编译器就可以通过，代码就能正常跑下去。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> Man<span class="token punctuation">{</span><span class="token punctuation">}</span>
	w <span class="token operator">:=</span> Woman<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">Wow</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token function">Wow</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> HelloOne <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Wow</span><span class="token punctuation">(</span>h HelloOne<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Man <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">type</span> Woman <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Man<span class="token punctuation">)</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;yo bro!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Woman<span class="token punctuation">)</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hi honey!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>类型只要实现了接口规定的所有方法，那就认为它实现了接口，而不是像java，需要显式的声明它实现了接口</li> <li>golang其实在传入到Wow之前，就把实现了接口的变量隐式的转换成了接口变量，所以可以像其他静态类型一样做编译检查</li></ul> <h3 id="底层结构"><a href="#底层结构" class="header-anchor">#</a> 底层结构</h3> <p>分成iface和eface，区别在于iface描述的接口包含方法，eface是空接口
<img src="/note/2019-06-21-13-45-55.png" alt=""></p> <h4 id="iface"><a href="#iface" class="header-anchor">#</a> iface</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> iface <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tab  <span class="token operator">*</span>itab
	data unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>
</code></pre></div><p>内部维护两个指针</p> <ol><li>tab指向itab实体，表示接口的类型以及赋给这个接口的实体类型</li> <li>data指向接口具体的值，一般是指向堆内存的指针</li></ol> <h4 id="itab"><a href="#itab" class="header-anchor">#</a> itab</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> itab <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	inter  <span class="token operator">*</span>interfacetype
	_type  <span class="token operator">*</span>_type
	link   <span class="token operator">*</span>itab
	hash   <span class="token builtin">uint32</span> <span class="token comment">// copy of _type.hash. Used for type switches.</span>
	bad    <span class="token builtin">bool</span>   <span class="token comment">// type does not implement interface</span>
	inhash <span class="token builtin">bool</span>   <span class="token comment">// has this itab been added to hash?</span>
	unused <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	fun    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// variable sized</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>_type描述实体的类型，包括内存对齐方式，大小等，实际上是描述go中各种数据类型的结构体</li> <li>inter描述了接口的类型</li> <li>fun字段放置了和接口方法对应的具体数据类型的方法地址，实现接口调用方法的动态分派。当给接口赋值时会更新这个表。需要注意的是，fun数组的大小是1，如果接口定义了多个方法时，数组存的是第一个方法的函数指针，其他方法是在它之后的内存中继续存粗，所以是ok的</li></ol> <h4 id="interfacetype"><a href="#interfacetype" class="header-anchor">#</a> interfacetype</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> interfacetype <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	typ     _type
	pkgpath name
	mhdr    <span class="token punctuation">[</span><span class="token punctuation">]</span>imethod
<span class="token punctuation">}</span>
</code></pre></div><ol><li>_type，跟前面的相同</li> <li>mhdr，表示接口所定义的函数列表</li> <li>pkgpath，记录定义接口的包名</li></ol> <h4 id="type"><a href="#type" class="header-anchor">#</a> _type</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> _type <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// 类型大小</span>
	size       <span class="token builtin">uintptr</span>
  ptrdata    <span class="token builtin">uintptr</span>
  <span class="token comment">// 类型的 hash 值</span>
  hash       <span class="token builtin">uint32</span>
  <span class="token comment">// 类型的 flag，和反射相关</span>
  tflag      tflag
  <span class="token comment">// 内存对齐相关</span>
  align      <span class="token builtin">uint8</span>
  fieldalign <span class="token builtin">uint8</span>
  <span class="token comment">// 类型的编号，有bool, slice, struct 等等等等</span>
	kind       <span class="token builtin">uint8</span>
	alg        <span class="token operator">*</span>typeAlg
	<span class="token comment">// gc 相关</span>
	gcdata    <span class="token operator">*</span><span class="token builtin">byte</span>
	str       nameOff
	ptrToThis typeOff
<span class="token punctuation">}</span>
</code></pre></div><p>举例：</p> <h4 id="接口变量可以储存任何实现了接口定义的所有方法的变量"><a href="#接口变量可以储存任何实现了接口定义的所有方法的变量" class="header-anchor">#</a> 接口变量可以储存任何实现了接口定义的所有方法的变量</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> r io<span class="token punctuation">.</span>Reader
tty<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
r <span class="token operator">=</span> tty
</code></pre></div><p><img src="/note/2019-06-21-14-47-33.png" alt=""></p> <ol><li>声明r是io.Reader类型，是个interface（静态类型），它的动态类型是nil，动态值也是nil</li> <li>定义一个tty，OpenFile返回的是个file的指针，*os.File</li> <li>r = tty，将r的动态类型变成*os.File，动态值非空，r可以用<code>&lt;value, type&gt;</code>表示<code>&lt;tty, *os.File&gt;</code></li> <li>r的fun中指向的方法是Read，但是储存了tty变量之后，r还具有了io.Writer接口的方法，所以</li></ol> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> w io<span class="token punctuation">.</span>Writer
w <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/27/2019, 11:44:29 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/Css.html" class="prev">
        Css
      </a></span> <span class="next"><a href="/note/C.html">
        C
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.2e5e5d15.js" defer></script><script src="/note/assets/js/2.0d9fcc6c.js" defer></script><script src="/note/assets/js/17.a05d7a88.js" defer></script>
  </body>
</html>
